<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Chad Sikorra">
        <link rel="canonical" href="http://www.phpldaptools.com/cookbook/Modifying-GPO-Links-on-OUs/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

	<title>Modifying GPO Links on OUs - LdapTools</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">LdapTools</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cookbook <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../Authenticating-a-User/">Authenticating a User</a>
</li>

                        
                            
<li >
    <a href="../Common-LDAP-Queries/">Common LDAP Queries</a>
</li>

                        
                            
<li >
    <a href="../Creating-a-Custom-Repository/">Creating a Custom Repository</a>
</li>

                        
                            
<li class="active">
    <a href="./">Modifying GPO Links on OUs</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../tutorials/AD-User-Modification/">AD User Modification</a>
</li>

                        
                            
<li >
    <a href="../../tutorials/Building-LDAP-Queries/">Building LDAP Queries</a>
</li>

                        
                            
<li >
    <a href="../../tutorials/Creating-AD-Password-Settings-Objects/">Creating AD Password Settings Objects</a>
</li>

                        
                            
<li >
    <a href="../../tutorials/Creating-LDAP-Objects/">Creating LDAP Objects</a>
</li>

                        
                            
<li >
    <a href="../../tutorials/LDIF-Files/">LDIF Files</a>
</li>

                        
                            
<li >
    <a href="../../tutorials/Modifying-LDAP-Objects/">Modifying LDAP Objects</a>
</li>

                        
                            
<li >
    <a href="../../tutorials/Using-the-LDAP-Manager/">Using the LDAP Manager</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../reference/Attribute-Converters/">Attribute Converters</a>
</li>

                        
                            
<li >
    <a href="../../reference/Default-Schema-Attributes/">Default Schema Attributes</a>
</li>

                        
                            
<li >
    <a href="../../reference/Events/">Events</a>
</li>

                        
                            
<li >
    <a href="../../reference/Logging/">Logging</a>
</li>

                        
                            
<li >
    <a href="../../reference/Main-Configuration/">Main Configuration</a>
</li>

                        
                            
<li >
    <a href="../../reference/Schema-Configuration/">Schema Configuration</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../Creating-a-Custom-Repository/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../tutorials/AD-User-Modification/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/ldaptools/ldaptools/">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#modifying-gpo-links-on-ous">Modifying GPO Links on OUs</a></li>
        
            <li><a href="#creating-an-ou-with-a-linked-gpo">Creating an OU With a Linked GPO</a></li>
        
            <li><a href="#modifying-gpos-on-an-existing-ou">Modifying GPOs on an Existing OU</a></li>
        
            <li><a href="#searching-for-ous-with-specific-gpo-links">Searching for OUs with Specific GPO Links</a></li>
        
            <li><a href="#using-gpolink-objects">Using GPOLink Objects</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="modifying-gpo-links-on-ous">Modifying GPO Links on OUs</h1>
<hr />
<p>When working with Active Directory OUs you may want to add, remove, or display GPOs that are linked to them. This can be
accomplished through the use of the <code>gpoLinks</code> attribute for the OU type. This attribute can be leveraged on OU creation
or modification to easily set what GPOs should be linked at that OU level. The attribute value functions as an array of 
<code>\LdapTools\Utilities\GPOLink</code> objects that full describe the GPO that is linked, and whether or not the GPO is enforced
and/or enabled. The order of the array of <code>GPOLink</code> objects returned represents the link order in AD starting from order
1 onwards.</p>
<h2 id="creating-an-ou-with-a-linked-gpo">Creating an OU With a Linked GPO</h2>
<p>For example, assume you would like to create an OU named "Employees" that should have 2 GPOs linked to it named 
"Employee Policy" and "Require Screensaver":</p>
<pre><code class="php">use LdapTools\Utilities\GPOLink;

$ldapObject = $ldap-&gt;createLdapObject();

try {
    $ldapObject-&gt;createOU()
        -&gt;in('dc=example,dc=local')
        -&gt;with(['name' =&gt; 'Employees', 'gpoLinks' =&gt; [
            new GPOLink('Employee Policy'), 
            new GPOLink('Require Screensaver')
         ]])
        -&gt;execute();
} catch (LdapConnectionException $e) {
    echo &quot;Failed to create OU - &quot;.$e-&gt;getMessage();
}
</code></pre>

<h2 id="modifying-gpos-on-an-existing-ou">Modifying GPOs on an Existing OU</h2>
<p>Assume you have an existing OU and would like to remove or add a GPO link from it:</p>
<pre><code class="php">use LdapTools\Object\LdapObjectType;
use LdapTools\Utilities\GPOLink;

//...

$repository = $ldap-&gt;getRepository(LdapObjectType::OU);

// gpoLinks are not retrieved by default, so make sure to select them.
$repository-&gt;setAttributes(['name', 'gpoLinks']);
$ou = $repository-&gt;findOneByName('My Special OU');

// Check for, and then remove, the name of an existing GPO if it is linked...
foreach ($ou-&gt;getGpoLinks() as $gpoLink) {
    if ($gpoLink-&gt;getGpo()-&gt;getName() == 'Require Screensaver') {
        $ou-&gt;removeGpoLinks($gpoLink);
    }
}

// Add a new GPO link to the OU that is set to be enforced...
$link = (new GPOLink('Restricted Access'))-&gt;setIsEnforced(true);
$ou-&gt;addGpoLinks($link);

// Now actually save the changes back to LDAP
try {
    $ldap-&gt;persist($ou);
} catch (LdapConnectionException $e) {
    echo &quot;Failed to modify OU - &quot;.$e-&gt;getMessage();
}
</code></pre>

<h2 id="searching-for-ous-with-specific-gpo-links">Searching for OUs with Specific GPO Links</h2>
<p>You can also use GPOLink objects in queries to check if a link exists on an OU. You can even get as granular as setting
whether the GPOLink is enforced/enabled or not.</p>
<pre><code>use LdapTools\Utilities\GPOLink;

$query = $ldap-&gt;buildLdapQuery()-&gt;fromOU();

// Find OUs with a link for a GPO named &quot;Some GPO&quot;...
$result = $query-&gt;select('name')
    -&gt;where($query-&gt;filter()-&gt;contains('gpoLinks', new GPOLink('Some GPO')))
    -&gt;getLdapQuery()
    -&gt;getResult();

foreach ($result as $ou) {
    echo &quot;OU: &quot;.$ou-&gt;name;
}
</code></pre>

<h2 id="using-gpolink-objects">Using GPOLink Objects</h2>
<p>The <code>\LdapTools\Utilities\GPOLink</code> class is used to represent a GPO linked to an OU. It has several helper methods for 
getting all of the details regarding the link.</p>
<p>A GPOLink can be constructed use a name, GUID, DN, or LdapObject:</p>
<pre><code>use LdapTools\Utilities\GPOLink;

// Create a link for a GPO named &quot;Server Baseline&quot;...
$link1 = new GPOLink('Server Baseline&quot;);

// Create a link for a specific string GUID that represents a GPO...
$link2 = new GPOLink('968c00d8-f755-4e34-b7e6-586fd60ff5de');

// Query for a GPO then create the link based off the result...
$gpo = $ldap-&gt;buildLdapQuery()-&gt;where([
        'objectClass' =&gt; 'groupPolicyContainer',
        'displayName' =&gt; 'Server Exceptions',
    ])
    -&gt;getLdapQuery()
    -&gt;getSingleResult();
$link3 = new GPOLink($gpo);

// Set the second link to be disabled...
$link2-&gt;setIsEnabled(false);

// Set the first link to be enforced...
$link1-&gt;setIsEnforced(true);

// Query for an OU to apply the GPO links to...
$ou = $ldap-&gt;buildLdapQuery()-&gt;fromOU()-&gt;where(['name' =&gt; 'Servers'])
    -&gt;getLdapQuery()
    -&gt;getSingleResult();

// The order in which you add the links is the order they end up in for processing...
$ou-&gt;set('gpoLinks', $link1, link2, $link3);
$ldap-&gt;persist($ou);
</code></pre>

<p>When searching for OUs you can inspect their GPO links to determine information about them:</p>
<pre><code>// Query for the GPO links for an OU...
$ou = $ldap-&gt;buildLdapQuery()
    -&gt;fromOU()
    -&gt;select('gpoLinks')
    -&gt;where(['name' =&gt; 'Servers'])
    -&gt;getLdapQuery()
    -&gt;getSingleResult();

foreach ($ou-&gt;get('gpoLinks') as $gpoLink) {
    // The GPO will be the LdapObject representation of the linked GPO... 
    $gpo = $gpoLink-&gt;getGpo();

    echo &quot;GPO Name: &quot;.$gpo-&gt;get('name');
    echo &quot;GPO GUID: &quot;.$gpo-&gt;get('guid');
    echo &quot;GPO DN: &quot;.$gpo-&gt;get('dn');

    // You can check specifically if the link is being enforced...
    if ($gpoLink-&gt;getIsEnforced()) {
        echo &quot;The link &quot;.$gpo-&gt;get('name').&quot; is being enforced.&quot;;
    }

    // You can check specifically if the link is actually enabled/disabled...
    if (!$gpoLink-&gt;getIsEnabled()) {
        echo &quot;The link &quot;.$gpo-&gt;get('name').&quot; is currently disabled.&quot;;
    }
}
</code></pre>

<p>In the above example, if during the loop you want to modify any of the GPOLink objects you should set all of the GPO
links back to the OU and then persist it back to LDAP:</p>
<pre><code>// Query for the GPO links for an OU...
$ou = $ldap-&gt;buildLdapQuery()
    -&gt;fromOU()
    -&gt;select('gpoLinks')
    -&gt;where(['name' =&gt; 'Servers'])
    -&gt;getLdapQuery()
    -&gt;getSingleResult();

// Lets enable any disabled links...
foreach ($ou-&gt;get('gpoLinks') as $gpoLink) {
    if (!$gpoLink-&gt;getIsEnabled()) {
        $gpoLink-&gt;setIsEnabled(true);
    }
}

// Replace the existing ones with the changes...
$ou-&gt;set('gpoLinks', $ou-&gt;get('gpoLinks'));
$ldap-&gt;persist($ou);
</code></pre></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
                <p>Copyright &copy; 2015, Chad Sikorra.</p>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
